<div th:fragment="component-input" th:remove="tag">
  <template>
    <v-card>
      <div class="row pointer" @click="showConfig = !showConfig">
        <v-col cols="9">
          <v-card-title>{{ inputName }}</v-card-title>
          <v-card-subtitle>
            <small>
              <a :href="docsUrl" target="_blank" @click.stop>
                {{ inputType }}
              </a>
            </small>
          </v-card-subtitle>
        </v-col>
        <v-col cols="3" class="d-flex align-center justify-center">
          <v-btn
            @click.stop="moveSchema('up')"
            icon
            :disabled="ableToMoveSchema('up')"
          >
            <v-icon> mdi-arrow-up </v-icon>
          </v-btn>
          <v-btn
            @click.stop="moveSchema('down')"
            icon
            :disabled="ableToMoveSchema('down')"
          >
            <v-icon> mdi-arrow-down </v-icon>
          </v-btn>
          <v-btn @click.stop="removeSchema" icon>
            <v-icon color="red"> mdi-delete-circle-outline </v-icon>
          </v-btn>
        </v-col>
      </div>

      <transition name="fade">
        <v-card-text v-show="showConfig">

          <!-- Name -->
          <component
            :is="'component-input-fields-name'"
            v-bind="{ path, inputType }"
          ></component>

          <!-- Remaining fields -->
          <template
            v-if="Object.keys(map).length > 0"
            v-for="(element, index) in elements"
          >
            <component
              v-if="map[element.name] !== undefined"
              :is="map[element.name].componentName"
              v-bind="{ 
                path: depthPath(index),
                field: map[element.name].field,
                rules: map[element.name].rules,
                i18n: map[element.name].i18n
               }"
            ></component>
            <component
              v-else
              :is="'component-input-fields-' + element.name"
              v-bind="{ path: depthPath(index), inputType }"
            ></component>
          </template>
        </v-card-text>
      </transition>
    </v-card>
  </template>

  <script th:inline="javascript">
    DOM = document.getElementsByTagName("template")[0];
    DOM.remove();

    Vue.component("component-input", {
      template: DOM.innerHTML.toString(),

      props: {
        path: String,
      },
      data() {
        return {
          showConfig: false,
          map: {},
        };
      },
      created() {
        this.map = app.$root._data.map;

        // TODO: Add cache to avoid unecessary requests
        fetch(`${app.$root._data.services.test2}?schemaName=${this.inputType}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(response.statusText);
            }
            return response.json();
          }).then((data) => {
            const rawJsonElements = _.get(data, 'json.elements[0]elements') || [];
            rawJsonElements.forEach((rawEl) => {
              if(this.elements.every(el => el.name !== rawEl.name)){
                this.elements.push(rawEl);
              }
            });
          });
      },
      methods: {
        depthPath(index) {
          return `${this.path}elements[${index}]`;
        },

        moveSchema(direction) {
          app.$root.moveSchema(this.path, direction);
        },

        ableToMoveSchema(direction) {
          return app.$root.ableToMoveSchema(this.path, direction);
        },

        removeSchema() {
          app.$root.removeSchema(this.path);
        },
      },
      computed: {
        json() {
          return this.$store.getters.jsonPath(this.path);
        },
        inputName() {
          return this.json.attributes.name;
        },
        inputType() {
          return this.json.attributes.type;
        },
        elements() {
          return this.json.elements;
        },
        docsUrl() {
          return `https://developer.enonic.com/docs/xp/stable/cms/input-types#${this.inputType.toLowerCase()}`;
        },
      },
    });
  </script>
</div>
